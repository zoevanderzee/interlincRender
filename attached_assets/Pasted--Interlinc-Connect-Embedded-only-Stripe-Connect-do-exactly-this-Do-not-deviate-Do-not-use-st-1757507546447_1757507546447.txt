üîí Interlinc Connect ‚Äî Embedded-only Stripe Connect (do exactly this)
Do not deviate. Do not use @stripe/stripe-js or accountLinks.create anywhere in this flow.
0) Env (must match modes)
Server: STRIPE_SECRET_KEY=sk_live_xxx (or sk_test_xxx)
Client: VITE_STRIPE_PUBLISHABLE_KEY=pk_live_xxx (or pk_test_xxx)
PK and SK must be from the same Stripe account and same mode.
1) Install deps
npm i express stripe @stripe/connect-js
2) Server routes (create these exactly)
Create server/connect.js
import express from "express";
import Stripe from "stripe";

const router = express.Router();
const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, { apiVersion: "2024-06-20" });

// TODO: Replace with real DB lookups on your User model.
async function getUserId(req) {
  // Use your auth/session. For now assume req.user.id exists.
  if (!req.user?.id) throw new Error("Auth required");
  return req.user.id;
}
async function getConnectForUser(userId) {
  // return { accountId, accountType } or null
  return await db.users.getConnect(userId); // IMPLEMENT
}
async function setConnectForUser(userId, data) {
  // data: { accountId, accountType }
  return await db.users.setConnect(userId, data); // IMPLEMENT
}

function assertKeyModesMatch(publishableKey) {
  if (!publishableKey) return;
  const pkMode = publishableKey.startsWith("pk_live_") ? "live"
              : publishableKey.startsWith("pk_test_") ? "test" : "unknown";
  const sk = process.env.STRIPE_SECRET_KEY || "";
  const skMode = sk.startsWith("sk_live_") ? "live"
              : sk.startsWith("sk_test_") ? "test" : "unknown";
  if (pkMode !== skMode) {
    const err = new Error(`Key mode mismatch (client=${pkMode}, server=${skMode})`);
    err.status = 400; throw err;
  }
}

/**
 * POST /api/connect/ensure-account
 * Idempotent: create a single **Express** account for this user and persist it.
 * Body: { country?: "GB", businessType?: "company"|"individual" }
 */
router.post("/connect/ensure-account", async (req, res) => {
  try {
    const userId = await getUserId(req);
    const country = req.body?.country || "GB";
    const businessType = req.body?.businessType; // optional

    const existing = await getConnectForUser(userId);
    if (existing?.accountId) {
      const acct = await stripe.accounts.retrieve(existing.accountId);
      if (acct.type === "standard") {
        return res.status(409).json({ error: "standard_account", message: "Embedded requires Express/Custom." });
      }
      return res.json({ accountId: acct.id, accountType: acct.type });
    }

    const acct = await stripe.accounts.create({
      type: "express",                 // <<< IMPORTANT: no Standard accounts
      country,
      ...(businessType ? { business_type: businessType } : {}),
      capabilities: {
        card_payments: { requested: true },
        transfers:     { requested: true },
      },
    });

    await setConnectForUser(userId, { accountId: acct.id, accountType: acct.type });
    res.json({ accountId: acct.id, accountType: acct.type });
  } catch (e) {
    console.error("[ensure-account]", e);
    res.status(e.status || 500).json({ error: e.message || "Unknown error" });
  }
});

/**
 * POST /api/connect/session
 * Create an **embedded** Account Session (onboarding + management).
 * Body: { accountId: "acct_...", publishableKey?: "pk_..." }
 * Returns: { client_secret: "<string>", needsOnboarding: boolean }
 */
router.post("/connect/session", async (req, res) => {
  try {
    const { accountId, publishableKey } = req.body || {};
    if (!accountId) return res.status(400).json({ error: "Missing accountId" });
    assertKeyModesMatch(publishableKey);

    const acct = await stripe.accounts.retrieve(accountId);
    if (acct.type === "standard") {
      return res.status(409).json({ error: "standard_account", message: "Embedded requires Express/Custom." });
    }

    const reqs = acct.requirements || {};
    const needsOnboarding =
      !acct.details_submitted ||
      (Array.isArray(reqs.currently_due) && reqs.currently_due.length > 0) ||
      (Array.isArray(reqs.past_due) && reqs.past_due.length > 0);

    const session = await stripe.accountSessions.create({
      account: accountId,
      components: {
        account_onboarding: { enabled: true },
        account_management: { enabled: true },
      },
    });

    if (!session.client_secret) throw new Error("No client_secret from Stripe");
    res.json({ client_secret: session.client_secret, needsOnboarding });
  } catch (e) {
    console.error("[connect/session]", e);
    res.status(e.status || 500).json({ error: e.message || "Unknown error" });
  }
});

export default router;
Wire it in server/index.js
import express from "express";
import connectRoutes from "./connect.js";

const app = express();
app.use(express.json());
app.use("/api", connectRoutes);
app.listen(process.env.PORT || 3000, () =>
  console.log("Server listening on :" + (process.env.PORT || 3000))
);
3) Client page (embedded-only)
Create client/src/pages/InterlincConnect.tsx
import { useEffect, useRef } from "react";
import { loadConnectAndInitialize } from "@stripe/connect-js";

const PK = (import.meta.env.VITE_STRIPE_PUBLISHABLE_KEY || "").trim();

export default function InterlincConnect() {
  const started = useRef(false);

  useEffect(() => {
    if (started.current) return;
    started.current = true;

    (async () => {
      if (!PK.startsWith("pk_")) throw new Error("Missing/invalid publishable key");

      // 1) Ensure (or fetch) user's Express account (idempotent)
      const r1 = await fetch("/api/connect/ensure-account", { method: "POST", headers: { "Content-Type": "application/json" } });
      if (!r1.ok) throw new Error(await r1.text());
      const { accountId } = await r1.json();

      // 2) Create embedded Account Session
      const r2 = await fetch("/api/connect/session", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ accountId, publishableKey: PK }),
      });
      const j = await r2.json();
      if (!r2.ok) {
        if (j?.error === "standard_account") throw new Error("This user has a Standard account; create Express/Custom.");
        throw new Error(j?.error || `API ${r2.status}`);
      }
      const { client_secret, needsOnboarding } = j;

      // 3) Initialize Connect and mount INSIDE the page (embedded)
      const connect = await loadConnectAndInitialize({
        publishableKey: PK,
        fetchClientSecret: async () => client_secret,
      });

      const componentName = needsOnboarding ? "account-onboarding" : "account-management";
      const comp = connect.create(componentName as any);
      comp.on?.("ready", () => console.log(`[connect] ${componentName} ready`));
      comp.mount("#onboarding-container");
    })().catch((e) => {
      console.error("Embedded Connect failed:", e);
      const box = document.getElementById("onboarding-container");
      if (box) box.textContent = `Connect error: ${e.message}`;
    });
  }, []);

  return (
    <div style={{ padding: 24, maxWidth: 720, margin: "0 auto" }}>
      <h1>Interlinc Connect</h1>
      <div id="onboarding-container" style={{ minHeight: 520, border: "1px solid #e5e7eb", borderRadius: 8 }} />
    </div>
  );
}
Add a route/nav link (point to this page, e.g., /interlinc-connect).
Vite dev proxy (if not present):
// vite.config.ts
import { defineConfig } from "vite";
import react from "@vitejs/plugin-react";
export default defineConfig({
  plugins: [react()],
  server: { proxy: { "/api": "http://localhost:3000" } },
});
4) ‚ÄúNo hosting‚Äù guard (prevents regressions)
Create scripts/guard_connect.sh
#!/usr/bin/env bash
set -euo pipefail
TARGET="client/src/pages/InterlincConnect.tsx"
if grep -E "accountLinks\.create|connectEmbeddedComponents|@stripe/stripe-js|appendChild\(" -n "$TARGET" >/dev/null; then
  echo "‚ùå Hosted onboarding or wrong SDK detected in $TARGET"; exit 1
else
  echo "‚úÖ Embedded-only codepath intact"
fi
Wire into build
// package.json
{
  "scripts": {
    "guard:connect": "bash scripts/guard_connect.sh",
    "build": "npm run guard:connect && vite build"
  }
}
5) Acceptance tests (must pass)
Server smoke
# should return { accountId: "acct_...", accountType: "express" }
curl -s -X POST http://localhost:3000/api/connect/ensure-account

# should return { client_secret: "<string>", needsOnboarding: true/false }
acct=$(curl -s -X POST http://localhost:3000/api/connect/ensure-account | jq -r .accountId)
curl -s -X POST http://localhost:3000/api/connect/session -H "Content-Type: application/json" \
  -d "{\"accountId\":\"$acct\",\"publishableKey\":\"$VITE_STRIPE_PUBLISHABLE_KEY\"}"
Browser checks on /interlinc-connect
Network shows /api/connect/ensure-account (200) and /api/connect/session (200).
Network shows https://connect-js.stripe.com/... requests (200s).
The onboarding UI renders inside #onboarding-container (no redirect).
6) Forbidden (fail the PR if any of these appear)
accountLinks.create (hosted onboarding)
@stripe/stripe-js on this page
Creating a Stripe account on page render outside /connect/ensure-account
Validating client secret by prefix (treat as opaque string)
Mounting with appendChild instead of the component‚Äôs mount(...)
7) CSP (if app uses it) ‚Äî allow Stripe
frame-src   https://connect-js.stripe.com https://js.stripe.com https://*.stripe.com;
script-src  'self' 'unsafe-inline' https://connect-js.stripe.com https://js.stripe.com https://*.stripe.com;
connect-src 'self' https://api.stripe.com https://connect-js.stripe.com https://*.stripe.com;
Implement exactly as above. Don‚Äôt ask follow-ups‚Äîship it now.