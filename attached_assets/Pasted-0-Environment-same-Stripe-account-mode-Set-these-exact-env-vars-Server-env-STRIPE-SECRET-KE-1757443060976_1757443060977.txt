0) Environment (same Stripe account & mode)
Set these exact env vars:
Server (.env)
STRIPE_SECRET_KEY=sk_live_xxx   # or sk_test_xxx
PORT=3000
Client (.env)
VITE_STRIPE_PUBLISHABLE_KEY=pk_live_xxx   # or pk_test_xxx  (MUST match the server mode)
Do NOT mix test/live. Both must be live or both test.
1) Server (Node + Express) — embedded-only
server/index.js
import express from "express";
import Stripe from "stripe";

const app = express();
app.use(express.json());

if (!process.env.STRIPE_SECRET_KEY) throw new Error("Missing STRIPE_SECRET_KEY");

const sk = process.env.STRIPE_SECRET_KEY;
const stripe = new Stripe(sk, { apiVersion: "2024-06-20" });

// Optional: sanity endpoint to prove which platform account & mode we're using
app.get("/api/connect/health", async (_req, res) => {
  const acct = await stripe.accounts.retrieve();
  const mode = sk.startsWith("sk_live_") ? "live" : sk.startsWith("sk_test_") ? "test" : "unknown";
  res.json({ platform_account_id: acct.id, mode });
});

/**
 * POST /api/connect/create-account-session
 * Body: { accountId?: string|null, country?: string, publishableKey?: string }
 * Returns: { accountId: "acct_...", client_secret: "seti_..." }
 */
app.post("/api/connect/create-account-session", async (req, res) => {
  try {
    let { accountId = null, country = "GB", publishableKey } = req.body || {};

    // Guard: PK/SK mode must match (prevents cross-account / test-live mixups)
    const pkMode = publishableKey?.startsWith("pk_live_") ? "live"
                 : publishableKey?.startsWith("pk_test_") ? "test" : "unknown";
    const skMode = sk.startsWith("sk_live_") ? "live"
                 : sk.startsWith("sk_test_") ? "test" : "unknown";
    if (publishableKey && pkMode !== skMode) {
      return res.status(400).json({ error: `Key mode mismatch (client=${pkMode}, server=${skMode})` });
    }

    if (!accountId) {
      const acct = await stripe.accounts.create({
        type: "custom",
        country,
        capabilities: { card_payments: { requested: true }, transfers: { requested: true } },
      });
      accountId = acct.id;
    }

    const session = await stripe.accountSessions.create({
      account: accountId,
      components: { account_onboarding: { enabled: true } },
    });

    return res.json({ accountId, client_secret: session.client_secret }); // seti_...
  } catch (e) {
    console.error("[connect] ERROR", e);
    res.status(500).json({ error: e?.message || "Unknown error" });
  }
});

app.listen(process.env.PORT || 3000, () =>
  console.log(`Server listening on :${process.env.PORT || 3000}`)
);
2) Client (React + Vite) — minimal & correct
Install
npm i @stripe/connect-js
vite.config.ts (dev proxy so /api works)
import { defineConfig } from "vite";
import react from "@vitejs/plugin-react";
export default defineConfig({
  plugins: [react()],
  server: { proxy: { "/api": "http://localhost:3000" } },
});
client/src/pages/ConnectOnboarding.tsx
import { useEffect, useRef } from "react";
import { loadConnectAndInitialize } from "@stripe/connect-js";

const PK = (import.meta.env.VITE_STRIPE_PUBLISHABLE_KEY || "").trim();

function assertPattern(name: string, val: any, re: RegExp) {
  if (typeof val !== "string") throw new Error(`${name} not a string`);
  if (!re.test(val)) throw new Error(`${name} invalid: ${String(val).slice(0,24)}…`);
}

export default function ConnectOnboarding() {
  const started = useRef(false);

  useEffect(() => {
    if (started.current) return;            // guard React StrictMode/HMR double-run
    started.current = true;

    // Surface JS errors (no silent fails)
    window.addEventListener("error", (e) => console.error("[error]", e.message, e.error));
    window.addEventListener("unhandledrejection", (e: any) => console.error("[unhandled]", e?.reason));

    (async () => {
      // 1) Validate publishable key
      assertPattern("VITE_STRIPE_PUBLISHABLE_KEY", PK, /^pk_(test|live)_[A-Za-z0-9]+/);

      // 2) Ask server for { accountId, client_secret }
      const resp = await fetch("/api/connect/create-account-session", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ accountId: null, country: "GB", publishableKey: PK }),
      });
      if (!resp.ok) throw new Error(`API ${resp.status}: ${await resp.text()}`);
      const { accountId, client_secret } = await resp.json();

      // 3) Validate shapes
      assertPattern("accountId", accountId, /^acct_[A-Za-z0-9]+/);
      assertPattern("client_secret", client_secret, /^seti_[A-Za-z0-9_]+/);

      // 4) Initialize Connect (NOT @stripe/stripe-js)
      const connect = await loadConnectAndInitialize({
        publishableKey: PK,
        fetchClientSecret: async () => client_secret,
      });

      // 5) Create & mount (no appendChild)
      const onboarding = connect.create("account-onboarding");
      if (typeof (onboarding as any).mount !== "function") {
        console.error("component:", onboarding);
        throw new Error("Connect component not mountable (wrong SDK/import or bad init)");
      }

      onboarding.on("ready", () => console.log("[connect] ready (embedded) for", accountId));
      onboarding.mount("#onboarding-container");
    })().catch((e) => {
      console.error("[embedded connect failed]", e);
      alert(String(e?.message || e));
    });
  }, []);

  return (
    <div style={{ padding: 24, maxWidth: 720, margin: "0 auto" }}>
      <h1>Embedded Connect Onboarding</h1>
      <div id="onboarding-container" style={{ minHeight: 520 }} />
    </div>
  );
}
On this page: never import @stripe/stripe-js, never call accountLinks.create, and never appendChild() the component.
3) Pre-build guard (prevents the usual mistakes)
scripts/guard_connect.sh
#!/usr/bin/env bash
set -euo pipefail
TARGET="client/src/pages/ConnectOnboarding.tsx"

echo "Guard: checking forbidden integrations in $TARGET"
if grep -E "accountLinks\.create|connectEmbeddedComponents|@stripe/stripe-js|appendChild\(" -n "$TARGET" >/dev/null; then
  echo "❌ Forbidden pattern found in $TARGET (hosted onboarding or wrong SDK)."
  exit 1
else
  echo "✅ No forbidden patterns in $TARGET"
fi
package.json
{
  "scripts": {
    "guard:connect": "bash scripts/guard_connect.sh",
    "build": "npm run guard:connect && vite build"
  }
}
4) One-shot verification (must return acct_ + seti_)
scripts/verify-connect-session.mjs
import fetch from "node-fetch";

const url = "http://localhost:3000/api/connect/create-account-session";
const res = await fetch(url, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ accountId: null, country: "GB" })
});
if (!res.ok) {
  console.error("❌ API failed:", await res.text());
  process.exit(1);
}
const j = await res.json();
const ok = typeof j.accountId === "string" && /^acct_/.test(j.accountId)
        && typeof j.client_secret === "string" && /^seti_/.test(j.client_secret);
if (!ok) {
  console.error("❌ Bad response shape:", j);
  process.exit(1);
}
console.log("✅ Session OK:", { accountId: j.accountId, client_secret_prefix: j.client_secret.slice(0,5) });
package.json
{
  "scripts": {
    "verify:connect": "node scripts/verify-connect-session.mjs"
  }
}
Run:
# Start server first
node server/index.js
# Verify
npm run verify:connect
# Expect: ✅ Session OK: { accountId: "acct_...", client_secret_prefix: "seti_" }
Only after this passes, open the page in the browser.
5) Definition of Done (must ALL be true)
npm run verify:connect passes (server returns acct_… and seti_…).
Browser → Network shows /api/connect/create-account-session 200 with same values.
The component renders inside #onboarding-container, no redirect.
Console prints: "[connect] ready (embedded) for acct_…".
The onboarding page only imports @stripe/connect-js.
No accountLinks.create anywhere in this flow.